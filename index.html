<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AI Chat</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f0f0f0;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  #overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.55); z-index: 100;
  }

  #sidebar {
    position: fixed; top: 0; left: -290px;
    width: 290px; height: 100dvh;
    background: #181818; z-index: 101;
    display: flex; flex-direction: column;
    transition: left 0.25s ease;
    border-right: 1px solid #2a2a2a;
  }

  #sidebar.open { left: 0; }

  .sidebar-header {
    padding: 14px 14px 10px;
    border-bottom: 1px solid #2a2a2a;
  }

  .sidebar-title {
    color: #888; font-size: 11px; text-transform: uppercase;
    letter-spacing: 1px; margin-bottom: 10px;
  }

  .sidebar-new-btns { display: flex; gap: 6px; }

  .snb {
    flex: 1; padding: 8px 6px; border-radius: 7px; border: 1px solid #333;
    background: #222; color: #ccc; font-size: 12px; font-family: inherit;
    cursor: pointer; text-align: center;
  }
  .snb.code { background: #0e2a1a; border-color: #1a4a2a; color: #6bcb9a; }
  .snb:active { opacity: 0.7; }

  #chat-list { flex: 1; overflow-y: auto; padding: 8px; }

  .chat-item {
    padding: 9px 10px; border-radius: 8px; cursor: pointer;
    margin-bottom: 3px; display: flex; align-items: center;
    justify-content: space-between; gap: 6px;
  }
  .chat-item:active, .chat-item.active { background: #252525; }

  .chat-item-info { flex: 1; overflow: hidden; }

  .chat-item-title {
    color: #ccc; font-size: 13px; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }

  .chat-item-meta { font-size: 10px; color: #555; margin-top: 2px; }
  .chat-item-meta.code { color: #4a9a6a; }

  .del-btn {
    background: none; border: none; color: #444;
    font-size: 17px; cursor: pointer; padding: 2px 5px; flex-shrink: 0;
  }
  .del-btn:active { color: #e55; }

  /* ‚îÄ‚îÄ FILE MANAGER PANEL ‚îÄ‚îÄ */
  #file-panel {
    position: fixed; top: 0; right: -300px;
    width: 300px; height: 100dvh;
    background: #181818; z-index: 101;
    display: flex; flex-direction: column;
    transition: right 0.25s ease;
    border-left: 1px solid #2a2a2a;
  }

  #file-panel.open { right: 0; }

  .file-panel-header {
    padding: 14px; border-bottom: 1px solid #2a2a2a;
    display: flex; align-items: center; justify-content: space-between;
  }

  .file-panel-title { color: #ccc; font-size: 14px; font-weight: 600; }

  .fp-close {
    background: none; border: none; color: #666;
    font-size: 20px; cursor: pointer;
  }

  .add-file-btn {
    margin: 10px; padding: 8px; border-radius: 7px;
    border: 1px dashed #333; background: none; color: #666;
    font-size: 13px; font-family: inherit; cursor: pointer; width: calc(100% - 20px);
  }
  .add-file-btn:active { background: #222; }

  #file-list { flex: 1; overflow-y: auto; padding: 0 8px 8px; }

  .file-item {
    padding: 10px 12px; border-radius: 8px; cursor: pointer;
    margin-bottom: 4px; border: 1px solid #252525; background: #1e1e1e;
    display: flex; align-items: center; justify-content: space-between;
  }
  .file-item:active, .file-item.active { border-color: #2a5a3a; background: #0e2a1a; }

  .file-item-name { color: #ccc; font-size: 13px; font-family: monospace; }
  .file-item-lang { color: #555; font-size: 10px; margin-top: 2px; }

  .file-del {
    background: none; border: none; color: #444;
    font-size: 15px; cursor: pointer;
  }

  /* ‚îÄ‚îÄ FILE VIEWER ‚îÄ‚îÄ */
  #file-viewer {
    display: none; flex-direction: column;
    flex: 1; overflow: hidden; background: #1e1e1e;
  }

  .fv-header {
    background: #252525; padding: 10px 14px;
    display: flex; align-items: center; gap: 10px;
    border-bottom: 1px solid #333; flex-shrink: 0;
  }

  .fv-back {
    background: none; border: none; color: #888;
    font-size: 18px; cursor: pointer;
  }

  .fv-name { color: #ccc; font-size: 14px; font-weight: 600; flex: 1; }

  .fv-copy {
    background: #333; border: none; border-radius: 5px;
    color: #ccc; font-size: 12px; font-family: inherit;
    padding: 5px 10px; cursor: pointer;
  }
  .fv-copy.copied { background: #1a4a2a; color: #6bcb9a; }

  #fv-code {
    flex: 1; overflow: auto; padding: 16px;
    font-family: 'Courier New', monospace; font-size: 13px;
    line-height: 1.6; color: #d4d4d4; white-space: pre;
  }

  /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
  .app {
    width: 100%; height: 100dvh; background: #fff;
    display: flex; flex-direction: column;
    max-width: 700px; margin: 0 auto;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    background: #2c2c2c; color: #fff;
    padding: 13px 14px; display: flex;
    align-items: center; gap: 10px; flex-shrink: 0;
  }

  .icon-btn {
    background: none; border: none; color: #fff;
    font-size: 20px; cursor: pointer; padding: 0 2px; flex-shrink: 0;
    line-height: 1;
  }

  .header-center { flex: 1; overflow: hidden; }

  .header-title {
    font-size: 15px; font-weight: 600;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .header-sub { font-size: 11px; color: #999; margin-top: 1px; }

  .mode-badge {
    font-size: 11px; padding: 4px 8px; border-radius: 5px;
    border: none; font-family: inherit; cursor: pointer; flex-shrink: 0;
    background: #3a3a3a; color: #aaa;
  }
  .mode-badge.code { background: #0e2a1a; color: #6bcb9a; }
  .mode-badge:active { opacity: 0.7; }

  /* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
  #setup-screen {
    flex: 1; display: flex; align-items: center;
    justify-content: center; padding: 24px 16px;
    background: #f7f7f7; overflow-y: auto;
  }

  .setup-box {
    background: #fff; border: 1px solid #ddd; border-radius: 10px;
    padding: 24px; width: 100%; max-width: 420px;
  }

  .setup-box h2 { font-size: 17px; color: #222; margin-bottom: 6px; font-weight: 600; }
  .setup-box p { font-size: 13px; color: #777; margin-bottom: 20px; line-height: 1.7; }
  .setup-box a { color: #444; }

  label {
    display: block; font-size: 11px; font-weight: 600; color: #555;
    margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;
  }

  input[type="password"], input[type="text"], select, textarea {
    width: 100%; border: 1px solid #ccc; border-radius: 6px;
    padding: 10px 12px; font-size: 14px; font-family: inherit; color: #222;
    background: #fafafa; outline: none; margin-bottom: 14px;
    transition: border-color 0.15s; -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus { border-color: #555; background: #fff; }
  textarea { resize: vertical; }

  .btn {
    width: 100%; background: #2c2c2c; color: #fff; border: none;
    border-radius: 6px; padding: 13px; font-size: 15px; font-weight: 600;
    font-family: inherit; cursor: pointer;
  }
  .btn:active { background: #111; }

  .err { color: #c00; font-size: 12px; margin-top: 8px; display: none; }

  /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
  #chat-screen { flex: 1; display: none; flex-direction: column; overflow: hidden; }

  #messages {
    flex: 1; overflow-y: auto; padding: 14px 12px;
    display: flex; flex-direction: column; gap: 10px;
    background: #f7f7f7; -webkit-overflow-scrolling: touch;
  }

  .msg { display: flex; gap: 8px; max-width: 92%; animation: fi 0.2s ease; }

  @keyframes fi {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg.ai { align-self: flex-start; }

  .avatar {
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; flex-shrink: 0; align-self: flex-end;
    color: #fff; font-weight: 700;
  }
  .avatar.ai-av { background: #555; }
  .avatar.user-av { background: #888; }

  .bubble {
    padding: 9px 13px; border-radius: 16px; font-size: 14px;
    line-height: 1.55; word-break: break-word;
  }

  .msg.user .bubble {
    background: #2c2c2c; color: #fff;
    border-bottom-right-radius: 4px; white-space: pre-wrap;
  }
  .msg.ai .bubble {
    background: #fff; color: #222; border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
  }

  /* ‚îÄ‚îÄ CODE BLOCKS ‚îÄ‚îÄ */
  .cw { margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }

  .ch {
    background: #2c2c2c; padding: 6px 12px;
    display: flex; align-items: center; justify-content: space-between;
  }

  .clang { color: #888; font-size: 11px; font-family: monospace; }

  .cbtn-row { display: flex; gap: 6px; }

  .cbtn {
    background: #444; border: none; border-radius: 4px;
    color: #ddd; font-size: 11px; font-family: inherit;
    padding: 3px 8px; cursor: pointer;
  }
  .cbtn:active { opacity: 0.7; }
  .cbtn.copied { background: #1a4a2a; color: #6bcb9a; }
  .cbtn.save { background: #1a3a5a; color: #6aaacb; }
  .cbtn.saved { background: #1a4a2a; color: #6bcb9a; }

  pre { background: #1e1e1e; padding: 12px; overflow-x: auto; margin: 0; }
  code { font-family: 'Courier New', monospace; font-size: 13px; color: #d4d4d4; white-space: pre; }

  .kw { color: #569cd6; } .str { color: #ce9178; }
  .cm { color: #6a9955; } .nm { color: #b5cea8; }

  /* ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ */
  .typing { display: flex; align-items: center; gap: 4px; padding: 3px 0; }
  .dot { width: 7px; height: 7px; background: #bbb; border-radius: 50%; animation: bo 1.1s infinite; }
  .dot:nth-child(2) { animation-delay: 0.18s; }
  .dot:nth-child(3) { animation-delay: 0.36s; }
  @keyframes bo { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }

  /* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
  .input-area {
    border-top: 1px solid #ddd; padding: 10px 12px;
    background: #fff; display: flex; gap: 8px;
    align-items: flex-end; flex-shrink: 0;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
  }

  #user-input {
    flex: 1; border: 1px solid #ccc; border-radius: 20px;
    padding: 9px 14px; font-size: 15px; font-family: inherit;
    outline: none; resize: none; max-height: 120px; line-height: 1.4;
    background: #fafafa; color: #222; margin-bottom: 0; -webkit-appearance: none;
  }
  #user-input:focus { border-color: #888; background: #fff; }
  #user-input::placeholder { color: #bbb; }

  #send-btn {
    width: 40px; height: 40px; background: #2c2c2c; border: none;
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  #send-btn.code { background: #1a4a2a; }
  #send-btn:disabled { background: #ccc; }
  #send-btn:active { opacity: 0.7; }

  /* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
  .welcome { text-align: center; padding: 36px 16px; color: #999; }
  .welcome h3 { font-size: 15px; color: #555; margin-bottom: 6px; }
  .welcome p { font-size: 13px; line-height: 1.6; }
  .chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 14px; }
  .chip {
    background: #fff; border: 1px solid #ccc; border-radius: 999px;
    padding: 7px 13px; font-size: 13px; color: #444;
    cursor: pointer; font-family: inherit;
  }
  .chip:active { background: #f0f0f0; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-bg {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 200;
    align-items: center; justify-content: center; padding: 24px;
  }
  .modal-bg.show { display: flex; }

  .modal {
    background: #fff; border-radius: 10px;
    padding: 22px; width: 100%; max-width: 320px;
  }
  .modal h3 { font-size: 15px; margin-bottom: 12px; color: #222; }
  .modal-btns { display: flex; gap: 8px; margin-top: 4px; }
  .mbtn {
    flex: 1; padding: 10px; border: none; border-radius: 6px;
    font-size: 14px; font-family: inherit; cursor: pointer; font-weight: 600;
  }
  .mbtn.p { background: #2c2c2c; color: #fff; }
  .mbtn.s { background: #eee; color: #333; }
</style>
</head>
<body>

<div id="overlay" onclick="closeSidebar(); closeFilePanel();"></div>

<!-- LEFT SIDEBAR: chats -->
<div id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">Your Chats</div>
    <div class="sidebar-new-btns">
      <button class="snb" onclick="newChat(false)">+ New Chat</button>
      <button class="snb code" onclick="newChat(true)">‚å®Ô∏è New Project</button>
    </div>
  </div>
  <div id="chat-list"></div>
</div>

<!-- RIGHT PANEL: file manager -->
<div id="file-panel">
  <div id="file-list-view" style="display:flex;flex-direction:column;height:100%;">
    <div class="file-panel-header">
      <div class="file-panel-title" id="fp-title">Project Files</div>
      <button class="fp-close" onclick="closeFilePanel()">√ó</button>
    </div>
    <button class="add-file-btn" onclick="addFile()">+ Save New File</button>
    <div id="file-list"></div>
  </div>
  <div id="file-viewer" style="display:none;flex-direction:column;height:100%;">
    <div class="fv-header">
      <button class="fv-back" onclick="closeFileViewer()">‚Äπ</button>
      <div class="fv-name" id="fv-name"></div>
      <button class="fv-copy" id="fv-copy-btn" onclick="copyFileCode()">Copy</button>
    </div>
    <pre id="fv-code"></pre>
  </div>
</div>

<!-- PROJECT NAME MODAL -->
<div class="modal-bg" id="name-modal">
  <div class="modal">
    <h3>Name your project</h3>
    <input type="text" id="proj-name" placeholder="e.g. My Website" />
    <div class="modal-btns">
      <button class="mbtn s" onclick="closeModal('name-modal')">Cancel</button>
      <button class="mbtn p" onclick="confirmProject()">Create ‚Üí</button>
    </div>
  </div>
</div>

<!-- SAVE FILE MODAL -->
<div class="modal-bg" id="save-modal">
  <div class="modal">
    <h3>Save file as</h3>
    <input type="text" id="file-name" placeholder="e.g. app.py" />
    <div class="modal-btns">
      <button class="mbtn s" onclick="closeModal('save-modal')">Cancel</button>
      <button class="mbtn p" onclick="confirmSaveFile()">Save</button>
    </div>
  </div>
</div>

<div class="app">
  <div class="header">
    <button class="icon-btn" onclick="openSidebar()">‚ò∞</button>
    <div class="header-center">
      <div class="header-title" id="header-title">AI Chat</div>
      <div class="header-sub" id="header-sub">not connected</div>
    </div>
    <button class="mode-badge" id="mode-badge" style="display:none" onclick="toggleMode()">üí¨ Chat</button>
    <button class="icon-btn" id="files-btn" style="display:none;font-size:17px;" onclick="openFilePanel()">üìÅ</button>
  </div>

  <!-- Setup -->
  <div id="setup-screen">
    <div class="setup-box">
      <h2>Connect to Groq AI</h2>
      <p>Enter your free Groq API key to get started.<br><br>
        Get one free at <a href="https://console.groq.com" target="_blank">console.groq.com</a> ‚Äî
        sign up, tap <strong>API Keys</strong>, create one. Starts with <strong>gsk_</strong>
      </p>
      <label>API Key</label>
      <input type="password" id="api-key" placeholder="gsk_..." autocomplete="off" />
      <label>Model</label>
      <select id="model">
        <option value="llama-3.3-70b-versatile">Llama 3.3 70B ‚Äî best quality</option>
        <option value="llama-3.1-8b-instant">Llama 3.1 8B ‚Äî faster</option>
        <option value="gemma2-9b-it">Gemma 2 9B ‚Äî Google's model</option>
        <option value="mixtral-8x7b-32768">Mixtral 8x7B ‚Äî long chats</option>
      </select>
      <button class="btn" onclick="connect()">Connect ‚Üí</button>
      <div class="err" id="err">Please enter your API key first.</div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat-screen">
    <div id="messages"></div>
    <div class="input-area">
      <textarea id="user-input" placeholder="Type a message..." rows="1" oninput="grow(this)"></textarea>
      <button id="send-btn" onclick="send()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let apiKey = '', model = '', busy = false;
let currentChatId = null;
let isCodeMode = false;
let pendingSaveCode = '';
let pendingSaveLang = '';

const CHAT_SYS = "You are a helpful, honest, and friendly AI assistant. Be clear and concise.";
const CODE_SYS = "You are an expert coding assistant. When writing code always use markdown code blocks with the language specified (e.g. ```python). Explain your code clearly. Help debug, write, and improve code for any language or framework.";

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function saveAll(d) { try { localStorage.setItem('ai_chats', JSON.stringify(d)); } catch(e){} }
function loadAll() { try { return JSON.parse(localStorage.getItem('ai_chats') || '{}'); } catch(e){ return {}; } }
function saveKey(k) { try { localStorage.setItem('groq_key', k); } catch(e){} }
function loadKey() { try { return localStorage.getItem('groq_key') || ''; } catch(e){ return ''; } }

// auto-fill key
const sk = loadKey();
if (sk) document.getElementById('api-key').value = sk;

// ‚îÄ‚îÄ CONNECT ‚îÄ‚îÄ
function connect() {
  apiKey = document.getElementById('api-key').value.trim();
  if (!apiKey) { document.getElementById('err').style.display = 'block'; return; }
  model = document.getElementById('model').value;
  saveKey(apiKey);

  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('header-sub').textContent = model;
  document.getElementById('mode-badge').style.display = 'inline';

  renderSidebar();
  const chats = loadAll();
  const ids = Object.keys(chats);
  ids.length > 0 ? loadChat(ids[ids.length - 1]) : newChat(false);
}

// ‚îÄ‚îÄ CHAT MANAGEMENT ‚îÄ‚îÄ
function newChat(codeMode) {
  closeSidebar();
  if (codeMode) { showModal('name-modal'); return; }
  createChat('New Chat', false);
}

function createChat(title, codeMode) {
  const id = Date.now().toString();
  const chats = loadAll();
  chats[id] = { title, codeMode, history: [], files: {}, created: Date.now() };
  saveAll(chats);
  loadChat(id);
  renderSidebar();
}

function loadChat(id) {
  const chats = loadAll();
  if (!chats[id]) return;
  currentChatId = id;
  const chat = chats[id];
  isCodeMode = chat.codeMode;

  document.getElementById('header-title').textContent = chat.title;
  document.getElementById('files-btn').style.display = isCodeMode ? 'inline' : 'none';

  updateModeUI();

  const msgs = document.getElementById('messages');
  msgs.innerHTML = '';

  if (chat.history.filter(m => m.role !== 'system').length === 0) {
    showWelcome();
  } else {
    chat.history.forEach(m => {
      if (m.role !== 'system') renderMsg(m.role === 'user' ? 'user' : 'ai', m.content, m.role === 'assistant');
    });
  }
  closeSidebar();
}

function deleteChat(id, e) {
  e.stopPropagation();
  const chats = loadAll();
  delete chats[id];
  saveAll(chats);
  renderSidebar();
  if (currentChatId === id) {
    const rem = Object.keys(loadAll());
    rem.length > 0 ? loadChat(rem[rem.length - 1]) : newChat(false);
  }
}

function renderSidebar() {
  const chats = loadAll();
  const list = document.getElementById('chat-list');
  list.innerHTML = '';
  const ids = Object.keys(chats).sort((a, b) => chats[b].created - chats[a].created);

  if (ids.length === 0) {
    list.innerHTML = '<div style="color:#444;font-size:13px;text-align:center;padding:24px;">No chats yet</div>';
    return;
  }

  ids.forEach(id => {
    const c = chats[id];
    const item = document.createElement('div');
    item.className = 'chat-item' + (id === currentChatId ? ' active' : '');
    item.onclick = () => loadChat(id);

    const info = document.createElement('div');
    info.className = 'chat-item-info';
    info.innerHTML = `<div class="chat-item-title">${esc(c.title)}</div>
      <div class="chat-item-meta ${c.codeMode ? 'code' : ''}">${c.codeMode ? '‚å®Ô∏è Project' : 'üí¨ Chat'} ¬∑ ${Object.keys(c.files || {}).length} files</div>`;

    const del = document.createElement('button');
    del.className = 'del-btn';
    del.textContent = '√ó';
    del.onclick = (e) => deleteChat(id, e);

    item.appendChild(info);
    item.appendChild(del);
    list.appendChild(item);
  });
}

// ‚îÄ‚îÄ MODE ‚îÄ‚îÄ
function toggleMode() {
  isCodeMode = !isCodeMode;
  const chats = loadAll();
  if (chats[currentChatId]) {
    chats[currentChatId].codeMode = isCodeMode;
    saveAll(chats);
  }
  document.getElementById('files-btn').style.display = isCodeMode ? 'inline' : 'none';
  updateModeUI();
}

function updateModeUI() {
  const badge = document.getElementById('mode-badge');
  const sendBtn = document.getElementById('send-btn');
  const input = document.getElementById('user-input');
  if (isCodeMode) {
    badge.textContent = '‚å®Ô∏è Code'; badge.className = 'mode-badge code';
    sendBtn.className = 'code';
    input.placeholder = 'Describe what you want to build or fix...';
  } else {
    badge.textContent = 'üí¨ Chat'; badge.className = 'mode-badge';
    sendBtn.className = '';
    input.placeholder = 'Type a message...';
  }
}

// ‚îÄ‚îÄ SIDEBAR / PANEL ‚îÄ‚îÄ
function openSidebar() {
  renderSidebar();
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('overlay').style.display = 'block';
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
}

function openFilePanel() {
  renderFileList();
  document.getElementById('file-panel').classList.add('open');
  document.getElementById('overlay').style.display = 'block';
}

function closeFilePanel() {
  document.getElementById('file-panel').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
  closeFileViewer();
}

// ‚îÄ‚îÄ FILE MANAGER ‚îÄ‚îÄ
function renderFileList() {
  const chats = loadAll();
  const chat = chats[currentChatId];
  if (!chat) return;

  document.getElementById('fp-title').textContent = chat.title + ' ‚Äî Files';

  const list = document.getElementById('file-list');
  list.innerHTML = '';
  const files = chat.files || {};
  const names = Object.keys(files);

  if (names.length === 0) {
    list.innerHTML = '<div style="color:#444;font-size:13px;text-align:center;padding:24px;">No files saved yet.<br>Ask the AI to write code,<br>then tap Save on the code block.</div>';
    return;
  }

  names.forEach(name => {
    const item = document.createElement('div');
    item.className = 'file-item';
    item.onclick = () => openFileViewer(name, files[name]);

    const lang = name.split('.').pop() || 'code';
    item.innerHTML = `
      <div>
        <div class="file-item-name">${esc(name)}</div>
        <div class="file-item-lang">${lang}</div>
      </div>`;

    const del = document.createElement('button');
    del.className = 'file-del';
    del.textContent = '√ó';
    del.onclick = (e) => { e.stopPropagation(); deleteFile(name); };
    item.appendChild(del);
    list.appendChild(item);
  });
}

function openFileViewer(name, code) {
  document.getElementById('file-list-view').style.display = 'none';
  const fv = document.getElementById('file-viewer');
  fv.style.display = 'flex';
  document.getElementById('fv-name').textContent = name;
  const lang = name.split('.').pop() || '';
  document.getElementById('fv-code').innerHTML = highlight(escHtml(code), lang);
  document.getElementById('fv-copy-btn').textContent = 'Copy';
  document.getElementById('fv-copy-btn').className = 'fv-copy';
  document.getElementById('fv-copy-btn').dataset.code = code;
}

function closeFileViewer() {
  document.getElementById('file-list-view').style.display = 'flex';
  document.getElementById('file-viewer').style.display = 'none';
}

function copyFileCode() {
  const code = document.getElementById('fv-copy-btn').dataset.code;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('fv-copy-btn');
    btn.textContent = 'Copied!'; btn.className = 'fv-copy copied';
    setTimeout(() => { btn.textContent = 'Copy'; btn.className = 'fv-copy'; }, 2000);
  });
}

function deleteFile(name) {
  const chats = loadAll();
  if (chats[currentChatId]) {
    delete chats[currentChatId].files[name];
    saveAll(chats);
    renderFileList();
  }
}

function addFile() {
  pendingSaveCode = '';
  pendingSaveLang = '';
  document.getElementById('file-name').value = '';
  showModal('save-modal');
}

function saveCodeToFile(code, lang) {
  pendingSaveCode = code;
  pendingSaveLang = lang;
  const ext = lang === 'javascript' || lang === 'js' ? 'js'
    : lang === 'python' ? 'py'
    : lang === 'html' ? 'html'
    : lang === 'css' ? 'css'
    : lang === 'typescript' || lang === 'ts' ? 'ts'
    : lang || 'txt';
  document.getElementById('file-name').value = 'file.' + ext;
  showModal('save-modal');
}

function confirmSaveFile() {
  const name = document.getElementById('file-name').value.trim();
  if (!name) return;
  closeModal('save-modal');
  const chats = loadAll();
  if (!chats[currentChatId]) return;
  if (!chats[currentChatId].files) chats[currentChatId].files = {};
  chats[currentChatId].files[name] = pendingSaveCode;
  saveAll(chats);
  renderSidebar();
}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function showModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function confirmProject() {
  const name = document.getElementById('proj-name').value.trim() || 'My Project';
  closeModal('name-modal');
  createChat('‚å®Ô∏è ' + name, true);
}

// ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ
function showWelcome() {
  const msgs = document.getElementById('messages');
  msgs.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'welcome';
  div.innerHTML = isCodeMode ? `
    <h3>‚å®Ô∏è Project Mode</h3>
    <p>Describe what you want to build or fix.<br>Tap üíæ on any code block to save it to your project files.</p>
    <div class="chips">
      <button class="chip" onclick="useSug(this)">Build a simple website</button>
      <button class="chip" onclick="useSug(this)">Write a Python script</button>
      <button class="chip" onclick="useSug(this)">Fix a bug in my code</button>
      <button class="chip" onclick="useSug(this)">Create a REST API</button>
    </div>` : `
    <h3>How can I help you?</h3>
    <p>Connected to Groq AI. Ask me anything.</p>
    <div class="chips">
      <button class="chip" onclick="useSug(this)">Explain something simply</button>
      <button class="chip" onclick="useSug(this)">Write a short story</button>
      <button class="chip" onclick="useSug(this)">Help me write an email</button>
      <button class="chip" onclick="useSug(this)">Give me a recipe idea</button>
    </div>`;
  msgs.appendChild(div);
}

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ
function grow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function useSug(el) {
  document.getElementById('user-input').value = el.textContent;
  send();
}

async function send() {
  const input = document.getElementById('user-input');
  const text = input.value.trim();
  if (!text || busy || !currentChatId) return;

  const welcome = document.querySelector('.welcome');
  if (welcome) welcome.remove();

  input.value = '';
  input.style.height = 'auto';
  busy = true;
  document.getElementById('send-btn').disabled = true;

  const chats = loadAll();
  const chat = chats[currentChatId];
  if (!chat) return;

  if (chat.history.length === 0) {
    chat.history.push({ role: 'system', content: chat.codeMode ? CODE_SYS : CHAT_SYS });
  }

  chat.history.push({ role: 'user', content: text });
  saveAll(chats);
  renderMsg('user', text, false);
  const typingEl = addTyping();

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
      body: JSON.stringify({ model, messages: chat.history })
    });

    typingEl.remove();

    if (!res.ok) {
      const err = await res.json();
      renderMsg('ai', '‚ö†Ô∏è Error: ' + (err?.error?.message || 'Something went wrong.'), false);
      chat.history.pop();
    } else {
      const data = await res.json();
      const reply = data.choices[0].message.content;
      chat.history.push({ role: 'assistant', content: reply });
      renderMsg('ai', reply, true);
    }
    saveAll(chats);
    renderSidebar();
  } catch(e) {
    typingEl.remove();
    renderMsg('ai', '‚ö†Ô∏è Could not reach Groq. Check your internet connection.', false);
    chat.history.pop();
  }

  busy = false;
  document.getElementById('send-btn').disabled = false;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderMsg(role, text, parse) {
  const wrap = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;

  const av = document.createElement('div');
  av.className = 'avatar ' + (role === 'user' ? 'user-av' : 'ai-av');
  av.textContent = role === 'user' ? 'U' : 'AI';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  if (role === 'ai' && parse) {
    bubble.innerHTML = parseMsg(text);
    bubble.querySelectorAll('.cbtn[data-action="copy"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const code = btn.closest('.cw').querySelector('code').textContent;
        navigator.clipboard.writeText(code).then(() => {
          btn.textContent = 'Copied!'; btn.classList.add('copied');
          setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
        });
      });
    });
    bubble.querySelectorAll('.cbtn[data-action="save"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const code = btn.closest('.cw').querySelector('code').textContent;
        const lang = btn.dataset.lang || '';
        saveCodeToFile(code, lang);
        btn.textContent = 'Saved!'; btn.classList.add('saved');
        setTimeout(() => { btn.textContent = 'üíæ Save'; btn.classList.remove('saved'); }, 2000);
      });
    });
  } else {
    bubble.textContent = text;
  }

  div.appendChild(av);
  div.appendChild(bubble);
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
  return div;
}

function parseMsg(text) {
  const parts = text.split(/(```[\s\S]*?```)/g);
  let html = '';
  parts.forEach(part => {
    if (part.startsWith('```')) {
      const lines = part.slice(3).split('\n');
      const lang = lines[0].trim() || 'code';
      const code = lines.slice(1).join('\n').replace(/```$/, '').trimEnd();
      const hi = highlight(escHtml(code), lang);
      const saveBtn = isCodeMode
        ? `<button class="cbtn save" data-action="save" data-lang="${esc(lang)}">üíæ Save</button>`
        : '';
      html += `<div class="cw">
        <div class="ch">
          <span class="clang">${esc(lang)}</span>
          <div class="cbtn-row">
            <button class="cbtn" data-action="copy">Copy</button>
            ${saveBtn}
          </div>
        </div>
        <pre><code>${hi}</code></pre>
      </div>`;
    } else {
      let p = escHtml(part);
      p = p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      p = p.replace(/`([^`]+)`/g, '<code style="background:#f0f0f0;padding:1px 5px;border-radius:3px;font-size:12px;">$1</code>');
      p = p.replace(/\n/g, '<br>');
      html += '<span>' + p + '</span>';
    }
  });
  return html;
}

function addTyping() {
  const wrap = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ai';
  const av = document.createElement('div');
  av.className = 'avatar ai-av'; av.textContent = 'AI';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = '<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
  div.appendChild(av); div.appendChild(bubble);
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
  return div;
}

// ‚îÄ‚îÄ SYNTAX ‚îÄ‚îÄ
function highlight(code, lang) {
  const kws = {
    python: /\b(def|class|import|from|return|if|elif|else|for|while|in|not|and|or|True|False|None|with|as|try|except|finally|raise|pass|break|continue|lambda|yield|global|nonlocal|del|assert|print)\b/g,
    javascript: /\b(const|let|var|function|return|if|else|for|while|in|of|new|this|class|import|export|default|try|catch|finally|throw|async|await|true|false|null|undefined|typeof|instanceof)\b/g,
    js: /\b(const|let|var|function|return|if|else|for|while|in|of|new|this|class|import|export|default|try|catch|finally|throw|async|await|true|false|null|undefined)\b/g,
    typescript: /\b(const|let|var|function|return|if|else|for|while|interface|type|enum|class|import|export|default|try|catch|async|await|true|false|null|undefined|string|number|boolean)\b/g,
    ts: /\b(const|let|var|function|return|if|else|for|while|interface|type|enum|class|import|export|default|try|catch|async|await|true|false|null|undefined|string|number|boolean)\b/g,
    css: /\b(color|background|margin|padding|display|flex|grid|font|border|width|height|position|top|left|right|bottom|overflow|opacity|transform|transition|animation|content|cursor|z-index)\b/g,
  };
  let h = code;
  const kw = kws[lang.toLowerCase()];
  if (kw) h = h.replace(kw, '<span class="kw">$1</span>');
  h = h.replace(/(["'`])(.*?)\1/g, '<span class="str">$1$2$1</span>');
  h = h.replace(/(#[^\n]*|\/\/[^\n]*|\/\*[\s\S]*?\*\/)/g, '<span class="cm">$1</span>');
  h = h.replace(/\b(\d+\.?\d*)\b/g, '<span class="nm">$1</span>');
  return h;
}

function escHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function esc(t) { return String(t).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>    flex-shrink: 0;
  }

  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-dot { width: 9px; height: 9px; background: #6bcb6b; border-radius: 50%; }
  .header-dot.off { background: #777; }
  .header h1 { font-size: 15px; font-weight: 600; }
  .header-model { font-size: 11px; color: #aaa; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .clear-btn {
    background: none; border: none; color: #bbb;
    font-size: 12px; font-family: inherit; cursor: pointer; padding: 4px 8px;
  }
  .clear-btn:hover { color: #eee; }

  /* Setup */
  #setup-screen {
    flex: 1; display: flex; align-items: center;
    justify-content: center; padding: 24px 16px;
    background: #f7f7f7; overflow-y: auto;
  }

  .setup-box {
    background: #fff; border: 1px solid #ddd; border-radius: 10px;
    padding: 24px; width: 100%; max-width: 420px;
  }

  .setup-box h2 { font-size: 17px; color: #222; margin-bottom: 6px; font-weight: 600; }
  .setup-box p { font-size: 13px; color: #777; margin-bottom: 20px; line-height: 1.7; }
  .setup-box a { color: #444; }

  label {
    display: block; font-size: 11px; font-weight: 600; color: #555;
    margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;
  }

  input[type="password"], select, textarea {
    width: 100%; border: 1px solid #ccc; border-radius: 6px;
    padding: 10px 12px; font-size: 14px; font-family: inherit; color: #222;
    background: #fafafa; outline: none; margin-bottom: 14px;
    transition: border-color 0.15s; -webkit-appearance: none;
  }

  input[type="password"]:focus, select:focus, textarea:focus {
    border-color: #555; background: #fff;
  }

  textarea { resize: vertical; }

  .btn {
    width: 100%; background: #2c2c2c; color: #fff; border: none;
    border-radius: 6px; padding: 13px; font-size: 15px; font-weight: 600;
    font-family: inherit; cursor: pointer; transition: background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active { background: #111; }

  .error { color: #c00; font-size: 12px; margin-top: 8px; display: none; }

  /* Chat */
  #chat-screen { flex: 1; display: none; flex-direction: column; overflow: hidden; }

  #messages {
    flex: 1; overflow-y: auto; padding: 16px 14px;
    display: flex; flex-direction: column; gap: 10px;
    background: #f7f7f7;
    -webkit-overflow-scrolling: touch;
  }

  .msg { display: flex; gap: 8px; max-width: 90%; animation: fadein 0.2s ease; }

  @keyframes fadein {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  .msg.ai { align-self: flex-start; }

  .avatar {
    width: 28px; height: 28px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-size: 11px;
    flex-shrink: 0; align-self: flex-end; color: #fff; font-weight: 700;
  }
  .avatar.ai-av { background: #555; }
  .avatar.user-av { background: #888; }

  .bubble {
    padding: 9px 13px; border-radius: 16px; font-size: 14px;
    line-height: 1.55; white-space: pre-wrap; word-break: break-word;
  }

  .msg.user .bubble {
    background: #2c2c2c; color: #fff; border-bottom-right-radius: 4px;
  }
  .msg.ai .bubble {
    background: #fff; color: #222; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px;
  }

  .typing { display: flex; align-items: center; gap: 4px; padding: 3px 0; }
  .dot {
    width: 7px; height: 7px; background: #bbb; border-radius: 50%;
    animation: bounce 1.1s infinite;
  }
  .dot:nth-child(2) { animation-delay: 0.18s; }
  .dot:nth-child(3) { animation-delay: 0.36s; }

  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
  }

  /* Input */
  .input-area {
    border-top: 1px solid #ddd; padding: 10px 12px;
    background: #fff; display: flex; gap: 8px;
    align-items: flex-end; flex-shrink: 0;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
  }

  #user-input {
    flex: 1; border: 1px solid #ccc; border-radius: 20px;
    padding: 9px 14px; font-size: 15px; font-family: inherit;
    outline: none; resize: none; max-height: 120px; line-height: 1.4;
    background: #fafafa; color: #222; transition: border-color 0.15s;
    margin-bottom: 0; -webkit-appearance: none;
  }
  #user-input:focus { border-color: #888; background: #fff; }
  #user-input::placeholder { color: #bbb; }

  #send-btn {
    width: 40px; height: 40px; background: #2c2c2c; border: none;
    border-radius: 50%; color: white; cursor: pointer; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0;
    transition: background 0.15s; -webkit-tap-highlight-color: transparent;
  }
  #send-btn:active { background: #444; }
  #send-btn:disabled { background: #ccc; }

  .welcome { text-align: center; padding: 40px 16px; color: #999; }
  .welcome h3 { font-size: 15px; color: #555; margin-bottom: 6px; }
  .welcome p { font-size: 13px; line-height: 1.6; }

  .chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }

  .chip {
    background: #fff; border: 1px solid #ccc; border-radius: 999px;
    padding: 7px 14px; font-size: 13px; color: #444; cursor: pointer;
    font-family: inherit; -webkit-tap-highlight-color: transparent;
  }
  .chip:active { background: #f0f0f0; }
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <div class="header-left">
      <div class="header-dot off" id="status-dot"></div>
      <h1>AI Chat</h1>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="header-model" id="model-label">not connected</span>
      <button class="clear-btn" id="clear-btn" onclick="clearChat()" style="display:none">Clear</button>
    </div>
  </div>

  <!-- Setup -->
  <div id="setup-screen">
    <div class="setup-box">
      <h2>Connect to Groq AI</h2>
      <p>
        Enter your free Groq API key to start chatting.<br><br>
        To get a key: go to <a href="https://console.groq.com" target="_blank">console.groq.com</a>,
        sign up with Google or email (no credit card needed), tap
        <strong>API Keys</strong> and create one. It starts with <strong>gsk_</strong>
      </p>

      <label>API Key</label>
      <input type="password" id="api-key" placeholder="gsk_..." autocomplete="off" />

      <label>Model</label>
      <select id="model">
        <option value="llama-3.3-70b-versatile">Llama 3.3 70B ‚Äî best quality</option>
        <option value="llama-3.1-8b-instant">Llama 3.1 8B ‚Äî faster</option>
        <option value="gemma2-9b-it">Gemma 2 9B ‚Äî Google's model</option>
        <option value="mixtral-8x7b-32768">Mixtral 8x7B ‚Äî long chats</option>
      </select>

      <label>Personality</label>
      <textarea id="system-prompt" rows="2">You are a helpful, honest, and friendly AI assistant. Be clear and concise.</textarea>

      <button class="btn" onclick="connect()">Connect ‚Üí</button>
      <div class="error" id="error">Please enter your API key first.</div>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat-screen">
    <div id="messages">
      <div class="welcome" id="welcome">
        <h3>How can I help you?</h3>
        <p>Connected to Groq AI. Ask me anything.</p>
        <div class="chips">
          <button class="chip" onclick="useSuggestion(this)">Explain something simply</button>
          <button class="chip" onclick="useSuggestion(this)">Write a short story</button>
          <button class="chip" onclick="useSuggestion(this)">Help me write an email</button>
          <button class="chip" onclick="useSuggestion(this)">Give me a recipe idea</button>
        </div>
      </div>
    </div>

    <div class="input-area">
      <textarea id="user-input" placeholder="Type a message..." rows="1"
        oninput="grow(this)"></textarea>
      <button id="send-btn" onclick="send()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>

</div>

<script>
  let apiKey, model, sysPrompt, history = [], busy = false;

  function connect() {
    apiKey = document.getElementById('api-key').value.trim();
    if (!apiKey) { document.getElementById('error').style.display = 'block'; return; }
    model = document.getElementById('model').value;
    sysPrompt = document.getElementById('system-prompt').value.trim();

    // Save key locally so user doesn't have to re-enter
    try { localStorage.setItem('groq_key', apiKey); } catch(e) {}

    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('chat-screen').style.display = 'flex';
    document.getElementById('status-dot').classList.remove('off');
    document.getElementById('model-label').textContent = model;
    document.getElementById('clear-btn').style.display = 'inline';
    history = [];
  }

  // Auto-fill saved key
  try {
    const saved = localStorage.getItem('groq_key');
    if (saved) document.getElementById('api-key').value = saved;
  } catch(e) {}

  function grow(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function useSuggestion(el) {
    document.getElementById('user-input').value = el.textContent;
    send();
  }

  async function send() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text || busy) return;

    const welcome = document.getElementById('welcome');
    if (welcome) welcome.remove();

    input.value = '';
    input.style.height = 'auto';
    busy = true;
    document.getElementById('send-btn').disabled = true;

    addMsg('user', text);
    history.push({ role: 'user', content: text });

    const typingEl = addTyping();

    try {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + apiKey
        },
        body: JSON.stringify({
          model: model,
          messages: [{ role: 'system', content: sysPrompt }, ...history]
        })
      });

      typingEl.remove();

      if (!res.ok) {
        const err = await res.json();
        addMsg('ai', '‚ö†Ô∏è Error: ' + (err?.error?.message || 'Something went wrong.'));
        history.pop();
      } else {
        const data = await res.json();
        const reply = data.choices[0].message.content;
        history.push({ role: 'assistant', content: reply });
        addMsg('ai', reply);
      }
    } catch (e) {
      typingEl.remove();
      addMsg('ai', '‚ö†Ô∏è Could not reach Groq. Check your internet connection and make sure your API key is correct.');
      history.pop();
    }

    busy = false;
    document.getElementById('send-btn').disabled = false;
  }

  function addMsg(role, text) {
    const wrap = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg ' + role;

    const av = document.createElement('div');
    av.className = 'avatar ' + (role === 'user' ? 'user-av' : 'ai-av');
    av.textContent = role === 'user' ? 'U' : 'AI';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    div.appendChild(av);
    div.appendChild(bubble);
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
  }

  function addTyping() {
    const wrap = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg ai';

    const av = document.createElement('div');
    av.className = 'avatar ai-av';
    av.textContent = 'AI';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = '<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';

    div.appendChild(av);
    div.appendChild(bubble);
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
    return div;
  }

  function clearChat() {
    history = [];
    document.getElementById('messages').innerHTML = '';
  }
</script>
</body>
</html>
